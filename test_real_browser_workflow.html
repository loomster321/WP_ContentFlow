<!DOCTYPE html>
<html>
<head>
    <title>WordPress Settings E2E Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .test-result { margin: 5px 0; }
        .pass { color: green; }
        .fail { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
        #test-iframe { width: 100%; height: 600px; border: 1px solid #ddd; }
        #log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>WordPress Content Flow Settings - Real Browser E2E Test</h1>
    
    <div class="test-section">
        <h3>Test Environment</h3>
        <div id="env-info">
            <div>WordPress URL: http://localhost:8080/wp-admin</div>
            <div>Test Page: Content Flow > Settings</div>
            <div>Credentials: admin / !3cTXkh)9iDHhV5o*N</div>
        </div>
    </div>

    <div class="test-section">
        <h3>E2E Test Controls</h3>
        <button onclick="runBasicTests()">1. Run Basic Tests</button>
        <button onclick="testFormSubmission()">2. Test Form Submission</button>
        <button onclick="testProviderChange()">3. Test Provider Change</button>
        <button onclick="loadSettingsPage()">Load Settings Page</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>Test Results</h3>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h3>Live WordPress Admin (for manual testing)</h3>
        <iframe id="test-iframe" src="about:blank"></iframe>
    </div>

    <div class="test-section">
        <h3>Test Log</h3>
        <div id="log"></div>
    </div>

    <script>
        let testResults = [];
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function addTestResult(test, status, details = '') {
            testResults.push({test, status, details, timestamp: new Date()});
            updateTestResults();
        }
        
        function updateTestResults() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = testResults.map(result => 
                `<div class="test-result ${result.status}">
                    ${result.status === 'pass' ? '✅' : '❌'} ${result.test}
                    ${result.details ? `<br>&nbsp;&nbsp;&nbsp;&nbsp;${result.details}` : ''}
                </div>`
            ).join('');
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            testResults = [];
            updateTestResults();
        }
        
        function loadSettingsPage() {
            log('Loading WordPress settings page...');
            const iframe = document.getElementById('test-iframe');
            iframe.src = 'http://localhost:8080/wp-admin/admin.php?page=wp-content-flow-settings';
            
            iframe.onload = function() {
                log('Settings page loaded successfully');
                addTestResult('Page Load', 'pass', 'WordPress settings page loaded');
                
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        
                        // Test 1: Check if form exists
                        const form = iframeDoc.querySelector('form');
                        if (form) {
                            addTestResult('Form Detection', 'pass', 'Settings form found on page');
                            log('Form found: ' + form.action);
                        } else {
                            addTestResult('Form Detection', 'fail', 'No form found on page');
                        }
                        
                        // Test 2: Check API key fields
                        const apiKeyFields = ['openai_api_key', 'anthropic_api_key', 'google_api_key'];
                        apiKeyFields.forEach(fieldName => {
                            const field = iframeDoc.querySelector(`[name*="${fieldName}"]`);
                            if (field) {
                                addTestResult(`${fieldName} Field`, 'pass', `Field found: ${field.type}`);
                            } else {
                                addTestResult(`${fieldName} Field`, 'fail', 'Field not found');
                            }
                        });
                        
                        // Test 3: Check provider dropdown
                        const providerSelect = iframeDoc.querySelector('[name*="default_ai_provider"]');
                        if (providerSelect) {
                            addTestResult('Provider Dropdown', 'pass', `Options: ${providerSelect.options.length}`);
                            log('Provider options: ' + Array.from(providerSelect.options).map(o => o.text).join(', '));
                        } else {
                            addTestResult('Provider Dropdown', 'fail', 'Dropdown not found');
                        }
                        
                        // Test 4: Check save button
                        const saveButton = iframeDoc.querySelector('input[type="submit"], button[type="submit"]');
                        if (saveButton) {
                            addTestResult('Save Button', 'pass', `Button text: ${saveButton.value || saveButton.textContent}`);
                        } else {
                            addTestResult('Save Button', 'fail', 'Save button not found');
                        }
                        
                    } catch (error) {
                        log('Error accessing iframe content: ' + error.message);
                        addTestResult('Page Analysis', 'fail', 'Cannot access iframe content - may need login');
                    }
                }, 1000);
            };
            
            iframe.onerror = function() {
                log('Error loading settings page');
                addTestResult('Page Load', 'fail', 'Could not load WordPress settings page');
            };
        }
        
        function runBasicTests() {
            log('Starting basic WordPress tests...');
            clearLog();
            
            // Test 1: Check if WordPress is accessible
            fetch('http://localhost:8080/wp-admin/')
                .then(response => {
                    if (response.ok) {
                        addTestResult('WordPress Access', 'pass', 'WordPress admin accessible');
                        log('WordPress admin is accessible');
                        loadSettingsPage();
                    } else {
                        addTestResult('WordPress Access', 'fail', `HTTP ${response.status}`);
                        log('WordPress admin not accessible: ' + response.status);
                    }
                })
                .catch(error => {
                    addTestResult('WordPress Access', 'fail', error.message);
                    log('WordPress connection error: ' + error.message);
                });
        }
        
        function testFormSubmission() {
            log('Testing form submission workflow...');
            
            const iframe = document.getElementById('test-iframe');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const form = iframeDoc.querySelector('form');
                
                if (!form) {
                    addTestResult('Form Submission Test', 'fail', 'No form found to test');
                    return;
                }
                
                log('Form action: ' + form.action);
                log('Form method: ' + form.method);
                
                // Fill in test data
                const openaiField = iframeDoc.querySelector('[name*="openai_api_key"]');
                const anthropicField = iframeDoc.querySelector('[name*="anthropic_api_key"]');
                const googleField = iframeDoc.querySelector('[name*="google_api_key"]');
                const providerSelect = iframeDoc.querySelector('[name*="default_ai_provider"]');
                
                if (openaiField) {
                    openaiField.value = 'test-openai-key-placeholder';
                    log('Filled OpenAI API key');
                }
                
                if (anthropicField) {
                    anthropicField.value = 'test-anthropic-key-placeholder';
                    log('Filled Anthropic API key');
                }
                
                if (googleField) {
                    googleField.value = 'test-google-key-placeholder';
                    log('Filled Google API key');
                }
                
                if (providerSelect) {
                    providerSelect.value = 'openai';
                    log('Changed provider to OpenAI');
                    addTestResult('Provider Change', 'pass', 'Successfully changed dropdown to OpenAI');
                }
                
                addTestResult('Form Fill', 'pass', 'All fields filled with test data');
                log('Form filled with test data. Ready for submission test.');
                
                // Note: We don't actually submit to avoid disrupting the test environment
                log('Form submission test prepared. Manual submission required.');
                
            } catch (error) {
                addTestResult('Form Submission Test', 'fail', error.message);
                log('Form submission test error: ' + error.message);
            }
        }
        
        function testProviderChange() {
            log('Testing provider dropdown change functionality...');
            
            const iframe = document.getElementById('test-iframe');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const providerSelect = iframeDoc.querySelector('[name*="default_ai_provider"]');
                
                if (!providerSelect) {
                    addTestResult('Provider Change Test', 'fail', 'Provider dropdown not found');
                    return;
                }
                
                const originalValue = providerSelect.value;
                log('Original provider value: ' + originalValue);
                
                // Test changing to different providers
                const providers = ['openai', 'anthropic', 'google'];
                providers.forEach(provider => {
                    if (provider !== originalValue) {
                        providerSelect.value = provider;
                        const newValue = providerSelect.value;
                        
                        if (newValue === provider) {
                            addTestResult(`Provider Change to ${provider}`, 'pass', `Successfully changed to ${provider}`);
                            log(`Successfully changed provider to: ${provider}`);
                        } else {
                            addTestResult(`Provider Change to ${provider}`, 'fail', `Failed to change to ${provider}`);
                            log(`Failed to change provider to: ${provider}`);
                        }
                    }
                });
                
                log('Provider change test completed');
                
            } catch (error) {
                addTestResult('Provider Change Test', 'fail', error.message);
                log('Provider change test error: ' + error.message);
            }
        }
        
        // Initialize
        log('WordPress Content Flow Settings E2E Test initialized');
        log('Click "Run Basic Tests" to start testing');
    </script>
</body>
</html>